<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chrome OS Desktop</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        :root {
            --primary: #4285f4;
            --surface: #f1f3f4;
            --on-surface: #202124;
            --elevation-2: 0 3px 6px rgba(0,0,0,0.1);
            --elevation-3: 0 8px 24px rgba(0,0,0,0.2);
        }

        .dark-mode {
            --surface: #202124;
            --on-surface: #e8eaed;
            --elevation-2: 0 3px 6px rgba(0,0,0,0.3);
            --elevation-3: 0 8px 24px rgba(0,0,0,0.5);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            height: 100vh;
            overflow: hidden;
            position: relative;
            transition: background 0.3s ease;
            touch-action: none;
            user-select: none;
        }
        
        /* Background */
        #background {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1950&q=80');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 1;
            transition: background-image 0.5s ease;
        }
        
        /* Desktop */
        #desktop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 56px;
            overflow: auto;
            padding: 20px;
            z-index: 2;
            touch-action: pan-x pan-y;
        }
        
        /* Desktop Icons Grid */
        .desktop-icons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            grid-auto-rows: 90px;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .desktop-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            background: rgba(0,0,0,0.2);
            backdrop-filter: blur(5px);
            user-select: none;
            text-decoration: none;
        }
        
        .desktop-icon:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .desktop-icon:active {
            transform: translateY(0);
        }
        
        .desktop-icon .material-icons {
            font-size: 36px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 8px;
            color: #4285f4;
        }
        
        .dark-mode .desktop-icon .material-icons {
            background: rgba(255,255,255,0.1);
            color: #8ab4f8;
        }
        
        .desktop-icon span {
            font-size: 12px;
            text-align: center;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            padding: 0 4px;
        }
        
        /* Windows */
        .window {
            position: absolute;
            background: var(--surface);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--elevation-3);
            min-width: 400px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            border: 1px solid #dadce0;
            resize: both;
            max-width: calc(100vw - 40px);
            max-height: calc(100vh - 96px);
            color: var(--on-surface);
            z-index: 100;
            touch-action: none;
        }
        
        .dark-mode .window {
            border-color: #5f6368;
        }
        
        .window.maximized {
            width: calc(100vw - 40px) !important;
            height: calc(100vh - 96px) !important;
            top: 20px !important;
            left: 20px !important;
            border-radius: 0;
            resize: none;
        }
        
        .window.minimized {
            display: none;
        }
        
        .window.active {
            z-index: 200;
        }
        
        .title-bar {
            height: 40px;
            background: #f8f9fa;
            border-bottom: 1px solid #dadce0;
            display: flex;
            align-items: center;
            padding: 0 12px;
            cursor: move;
            user-select: none;
            position: relative;
            z-index: 101;
            touch-action: none;
        }
        
        .dark-mode .title-bar {
            background: #3c4043;
            border-color: #5f6368;
        }
        
        .window-icon {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            color: #5f6368;
        }
        
        .dark-mode .window-icon {
            color: #e8eaed;
        }
        
        .title-text {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            color: #3c4043;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .dark-mode .title-text {
            color: #e8eaed;
        }
        
        .window-controls {
            display: flex;
            gap: 4px;
        }
        
        .win-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            color: #5f6368;
            position: relative;
            z-index: 102;
            touch-action: manipulation;
        }
        
        .dark-mode .win-btn {
            color: #e8eaed;
        }
        
        .win-btn:hover {
            background: rgba(0,0,0,0.1);
        }
        
        .dark-mode .win-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .win-btn.close:hover {
            background: #d93025;
            color: white;
        }
        
        .window-content {
            flex: 1;
            overflow: hidden;
            background: white;
            position: relative;
            z-index: 100;
        }
        
        .dark-mode .window-content {
            background: #202124;
        }
        
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            position: relative;
            z-index: 1;
        }
        
        .dark-mode iframe {
            background: #202124;
        }
        
        /* Shelf/Taskbar */
        #shelf {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
        }
        
        .dark-mode #shelf {
            background: rgba(32,33,36,0.95);
            border-color: #5f6368;
        }
        
        #app-launcher {
            width: 48px;
            height: 48px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 20px;
            position: relative;
            z-index: 1001;
            touch-action: manipulation;
        }
        
        #app-launcher:hover {
            background: #3367d6;
            transform: scale(1.05);
        }
        
        #taskbar {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            overflow-x: auto;
            padding: 0 10px;
            position: relative;
            z-index: 1001;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        #taskbar::-webkit-scrollbar {
            display: none;
        }
        
        .taskbar-item {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            z-index: 1001;
            flex-shrink: 0;
            touch-action: manipulation;
        }
        
        .taskbar-item:hover {
            background: rgba(0,0,0,0.05);
        }
        
        .dark-mode .taskbar-item:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .taskbar-item.active {
            background: rgba(66,133,244,0.1);
        }
        
        .dark-mode .taskbar-item.active {
            background: rgba(138,180,248,0.1);
        }
        
        .taskbar-item.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 16px;
            height: 3px;
            background: var(--primary);
            border-radius: 2px;
        }
        
        .taskbar-item .material-icons {
            font-size: 24px;
            color: #5f6368;
        }
        
        .dark-mode .taskbar-item .material-icons {
            color: #e8eaed;
        }
        
        .taskbar-item.active .material-icons {
            color: var(--primary);
        }
        
        #system-tray {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            position: relative;
            z-index: 1001;
        }
        
        .system-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
            touch-action: manipulation;
        }
        
        .system-icon:hover {
            background: rgba(0,0,0,0.05);
        }
        
        .dark-mode .system-icon:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .system-icon .material-icons {
            font-size: 20px;
            color: #5f6368;
        }
        
        .dark-mode .system-icon .material-icons {
            color: #e8eaed;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            overflow: hidden;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
            font-size: 14px;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #clock {
            font-size: 14px;
            font-weight: 500;
            color: #3c4043;
            margin-left: 16px;
            white-space: nowrap;
        }
        
        .dark-mode #clock {
            color: #e8eaed;
        }
        
        /* Settings Modal */
        .settings-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            background: var(--surface);
            border-radius: 12px;
            box-shadow: var(--elevation-3);
            z-index: 2000;
            color: var(--on-surface);
            border: 1px solid #dadce0;
            overflow: hidden;
        }
        
        .dark-mode .settings-modal {
            border-color: #5f6368;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #dadce0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .dark-mode .modal-header {
            border-color: #5f6368;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 500;
        }
        
        .modal-content {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(90vh - 140px);
        }
        
        .setting-item {
            margin-bottom: 20px;
        }
        
        .setting-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: var(--on-surface);
        }
        
        .setting-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        select, input[type="text"], input[type="range"] {
            flex: 1;
            padding: 10px;
            border: 1px solid #dadce0;
            border-radius: 8px;
            background: var(--surface);
            color: var(--on-surface);
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
        }
        
        .dark-mode select,
        .dark-mode input[type="text"],
        .dark-mode input[type="range"] {
            border-color: #5f6368;
            background: #3c4043;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        
        .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #dadce0;
            border-radius: 4px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .checkbox.checked {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        .checkbox.checked::after {
            content: 'âœ“';
            color: white;
            font-size: 14px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #dadce0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .dark-mode .modal-footer {
            border-color: #5f6368;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
            transition: background 0.2s;
            font-size: 14px;
            touch-action: manipulation;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #3367d6;
        }
        
        .btn-secondary {
            background: #f1f3f4;
            color: #202124;
        }
        
        .dark-mode .btn-secondary {
            background: #3c4043;
            color: #e8eaed;
        }
        
        .btn-secondary:hover {
            background: #e8eaed;
        }
        
        .dark-mode .btn-secondary:hover {
            background: #5f6368;
        }
        
        /* App Launcher */
        .app-launcher-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .dark-mode .app-launcher-modal {
            background: rgba(32,33,36,0.95);
        }
        
        /* Account Modal */
        .account-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            max-width: 90%;
            background: var(--surface);
            border-radius: 12px;
            box-shadow: var(--elevation-3);
            z-index: 2000;
            color: var(--on-surface);
            border: 1px solid #dadce0;
            overflow: hidden;
        }
        
        .dark-mode .account-modal {
            border-color: #5f6368;
        }
        
        .account-header {
            padding: 20px;
            border-bottom: 1px solid #dadce0;
            text-align: center;
            position: relative;
        }
        
        .dark-mode .account-header {
            border-color: #5f6368;
        }
        
        .account-title {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .account-subtitle {
            font-size: 14px;
            color: #5f6368;
        }
        
        .dark-mode .account-subtitle {
            color: #9aa0a6;
        }
        
        .account-content {
            padding: 20px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            padding: 15px;
            background: rgba(0,0,0,0.02);
            border-radius: 8px;
        }
        
        .dark-mode .user-info {
            background: rgba(255,255,255,0.05);
        }
        
        .user-avatar-large {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            overflow: hidden;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .user-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-details {
            flex: 1;
            min-width: 0;
        }
        
        .user-name {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-email {
            font-size: 14px;
            color: #5f6368;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .dark-mode .user-email {
            color: #9aa0a6;
        }
        
        .login-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .login-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 12px 20px;
            border: 1px solid #dadce0;
            border-radius: 8px;
            background: white;
            color: #3c4043;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }
        
        .dark-mode .login-btn {
            background: #3c4043;
            border-color: #5f6368;
            color: #e8eaed;
        }
        
        .login-btn:hover {
            background: #f8f9fa;
            border-color: #c1c1c1;
        }
        
        .dark-mode .login-btn:hover {
            background: #5f6368;
            border-color: #9aa0a6;
        }
        
        .login-btn.google {
            background: #4285f4;
            color: white;
            border-color: #4285f4;
        }
        
        .login-btn.google:hover {
            background: #3367d6;
            border-color: #3367d6;
        }
        
        .google-icon {
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 2px;
            padding: 1px;
        }
        
        .login-btn.signout {
            background: #f1f3f4;
            color: #d93025;
            border-color: #dadce0;
        }
        
        .login-btn.signout:hover {
            background: #fce8e6;
            border-color: #f28b82;
        }
        
        .account-footer {
            padding: 20px;
            border-top: 1px solid #dadce0;
            text-align: center;
            font-size: 12px;
            color: #5f6368;
        }
        
        .dark-mode .account-footer {
            border-color: #5f6368;
            color: #9aa0a6;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #4285f4;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
        }
        
        .dark-mode ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 4px;
        }
        
        .dark-mode ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.3);
        }
        
        .dark-mode ::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Desktop click handling */
        #desktop:active {
            cursor: default;
        }
        
        /* Modal overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 1999;
        }
        
        /* Drag/resize handle */
        .window-resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 15px;
            height: 15px;
            cursor: nwse-resize;
            z-index: 101;
        }
    </style>
</head>
<body class="light-mode">
    <div id="background"></div>
    <div id="desktop">
        <div class="desktop-icons-grid" id="desktop-icons"></div>
    </div>
    
    <div id="shelf">
        <button id="app-launcher">
            <span class="material-icons">apps</span>
        </button>
        <div id="taskbar"></div>
        <div id="system-tray">
            <div class="system-icon" id="settings-btn" title="Settings">
                <span class="material-icons">settings</span>
            </div>
            <div class="system-icon" id="notifications-btn" title="Notifications">
                <span class="material-icons">notifications</span>
            </div>
            <div class="system-icon" id="account-btn" title="Account">
                <div id="account-avatar" class="user-avatar">
                    <span class="material-icons">account_circle</span>
                </div>
            </div>
            <div id="clock">10:00 AM</div>
        </div>
    </div>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyCK4ehah9mZ9h8PWtDXOrEJqdEcNefGGtY",
            authDomain: "endroid-search.firebaseapp.com",
            projectId: "endroid-search",
            storageBucket: "endroid-search.firebasestorage.app",
            messagingSenderId: "36139140746",
            appId: "1:36139140746:web:ca9c3ce0065998eda28f73",
            measurementId: "G-5KY8LBYL8P"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // Apps configuration
        const apps = [
            {
                id: 'chrome',
                name: 'Chrome',
                url: 'https://www.google.com/webhp?igu=1',
                icon: 'language',
                taskbar: true,
                desktop: true
            },
            {
                id: 'calculator',
                name: 'Calculator',
                url: 'https://wized2.github.io/Calculator',
                icon: 'calculate',
                taskbar: true,
                desktop: true
            },
            {
                id: 'clock',
                name: 'Clock',
                url: 'https://wized2.github.io/Clock/',
                icon: 'schedule',
                taskbar: true,
                desktop: true
            },
            {
                id: 'notes',
                name: 'Notes',
                url: 'https://wized2.github.io/Notes/',
                icon: 'note',
                taskbar: true,
                desktop: true
            },
            {
                id: 'calendar',
                name: 'Calendar',
                url: 'https://calendar.google.com/calendar/embed?src=f5a7ee6f7cffe3a8e9bc82fb25507fa5ffa332d2b03d0412c4f7c32e6f07a129%40group.calendar.google.com&ctz=Asia%2FKarachi',
                icon: 'calendar_today',
                taskbar: true,
                desktop: true
            },
            {
                id: 'music',
                name: 'Music',
                url: 'https://wized2.github.io/Music/',
                icon: 'music_note',
                taskbar: true,
                desktop: true
            }
        ];

        // Chrome OS wallpapers
        const wallpapers = [
            'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1950&q=80',
            'https://images.unsplash.com/photo-1519681393784-d120267933ba?ixlib=rb-4.0.3&auto=format&fit=crop&w=1950&q=80',
            'https://images.unsplash.com/photo-1518837695005-2083093ee35b?ixlib=rb-4.0.3&auto=format&fit=crop&w=1950&q=80',
            'https://images.unsplash.com/photo-1499002238440-d264edd596ec?ixlib=rb-4.0.3&auto=format&fit=crop&w=1950&q=80',
            'https://images.unsplash.com/photo-1519681393784-d120267933ba?ixlib=rb-4.0.3&auto=format&fit=crop&w=1950&q=80'
        ];

        // State management
        const windows = new Map();
        const taskbarItems = new Map();
        const desktopIcons = new Map();
        let windowZIndex = 100;
        let activeWindow = null;
        let settings = {
            theme: 'light',
            iconsPerRow: 8,
            backgroundUrl: wallpapers[0],
            customBackgroundUrl: ''
        };
        let currentUser = null;

        // Load settings from localStorage
        function loadSettings() {
            try {
                const saved = localStorage.getItem('chromeOS-settings');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    Object.assign(settings, parsed);
                }
                applySettings();
            } catch (e) {
                console.error('Error loading settings:', e);
            }
        }

        // Save settings to localStorage
        function saveSettings() {
            try {
                localStorage.setItem('chromeOS-settings', JSON.stringify(settings));
            } catch (e) {
                console.error('Error saving settings:', e);
            }
        }

        // Apply settings
        function applySettings() {
            // Apply theme
            if (settings.theme === 'dark') {
                document.body.classList.add('dark-mode');
                document.body.classList.remove('light-mode');
            } else {
                document.body.classList.add('light-mode');
                document.body.classList.remove('dark-mode');
            }

            // Apply background
            const background = document.getElementById('background');
            const bgUrl = settings.customBackgroundUrl || settings.backgroundUrl;
            if (bgUrl) {
                // Preload image to avoid flickering
                const img = new Image();
                img.onload = () => {
                    background.style.backgroundImage = `url('${bgUrl}')`;
                };
                img.onerror = () => {
                    console.warn('Failed to load background image, using default');
                    background.style.backgroundImage = `url('${wallpapers[0]}')`;
                };
                img.src = bgUrl;
            }
        }

        // Update user avatar display
        function updateUserDisplay(user) {
            const accountAvatar = document.getElementById('account-avatar');
            
            if (user) {
                // User is signed in
                const displayName = user.displayName || 'User';
                const photoURL = user.photoURL;
                const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                
                if (photoURL) {
                    accountAvatar.innerHTML = `<img src="${photoURL}" alt="${displayName}" onerror="this.onerror=null; this.parentElement.innerHTML='<span>${initials}</span>'; this.parentElement.style.backgroundColor=getRandomColor();">`;
                } else {
                    accountAvatar.innerHTML = `<span>${initials}</span>`;
                    accountAvatar.style.backgroundColor = getRandomColor();
                }
                
                // Update account button title
                document.getElementById('account-btn').title = `${displayName} (${user.email})`;
            } else {
                // User is signed out
                accountAvatar.innerHTML = '<span class="material-icons">account_circle</span>';
                accountAvatar.style.backgroundColor = 'transparent';
                document.getElementById('account-btn').title = 'Account';
            }
        }

        // Generate random color for avatar background
        function getRandomColor() {
            const colors = ['#4285f4', '#ea4335', '#fbbc04', '#34a853', '#ff6d01', '#46bdc6', '#8a2be2'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // Sign in with Google
        async function signInWithGoogle() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('profile');
                provider.addScope('email');
                
                const result = await auth.signInWithPopup(provider);
                currentUser = result.user;
                updateUserDisplay(currentUser);
                
                showNotification(`Welcome, ${currentUser.displayName}!`);
                
                return result.user;
            } catch (error) {
                console.error('Error signing in with Google:', error);
                showNotification('Failed to sign in. Please try again.', true);
                return null;
            }
        }

        // Sign out
        async function signOut() {
            try {
                await auth.signOut();
                currentUser = null;
                updateUserDisplay(null);
                showNotification('Signed out successfully');
            } catch (error) {
                console.error('Error signing out:', error);
                showNotification('Failed to sign out. Please try again.', true);
            }
        }

        // Show notification
        function showNotification(message, isError = false) {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                background: ${isError ? '#ea4335' : '#34a853'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 3000;
                animation: slideIn 0.3s ease;
                font-weight: 500;
                max-width: 300px;
                word-wrap: break-word;
                backdrop-filter: blur(10px);
            `;
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
            
            // Add CSS animations if not already present
            if (!document.querySelector('#notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Create modal overlay
        function createModalOverlay() {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            return overlay;
        }

        // Show account modal
        function showAccountModal() {
            const overlay = createModalOverlay();
            const modal = document.createElement('div');
            modal.className = 'account-modal';
            
            if (currentUser) {
                // User is signed in - show profile
                const displayName = currentUser.displayName || 'User';
                const email = currentUser.email;
                const photoURL = currentUser.photoURL;
                const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                
                modal.innerHTML = `
                    <div class="account-header">
                        <div class="account-title">Account</div>
                        <div class="account-subtitle">Manage your account settings</div>
                    </div>
                    <div class="account-content">
                        <div class="user-info">
                            <div class="user-avatar-large">
                                ${photoURL ? `<img src="${photoURL}" alt="${displayName}" onerror="this.onerror=null; this.parentElement.innerHTML='<span>${initials}</span>'; this.parentElement.style.backgroundColor=getRandomColor();">` : `<span>${initials}</span>`}
                            </div>
                            <div class="user-details">
                                <div class="user-name">${displayName}</div>
                                <div class="user-email">${email}</div>
                            </div>
                        </div>
                        <div class="login-options">
                            <button class="login-btn signout" id="signout-btn">
                                <span class="material-icons">logout</span>
                                Sign Out
                            </button>
                        </div>
                    </div>
                    <div class="account-footer">
                        Endroid OS Desktop v1.0 Beta
                    </div>
                `;
            } else {
                // User is signed out - show login options
                modal.innerHTML = `
                    <div class="account-header">
                        <div class="account-title">Sign In</div>
                        <div class="account-subtitle">Sign in to sync your preferences</div>
                    </div>
                    <div class="account-content">
                        <div class="login-options">
                            <button class="login-btn google" id="google-signin-btn">
                                <svg class="google-icon" viewBox="0 0 24 24">
                                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                Sign in with Google
                            </button>
                            <button class="login-btn" id="guest-btn">
                                <span class="material-icons">person</span>
                                Continue as Guest
                            </button>
                        </div>
                    </div>
                    <div class="account-footer">
                        Sign in to sync your settings across devices
                    </div>
                `;
            }
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            
            // Add close button
            const closeBtn = document.createElement('button');
            closeBtn.className = 'win-btn close';
            closeBtn.style.position = 'absolute';
            closeBtn.style.top = '10px';
            closeBtn.style.right = '10px';
            closeBtn.innerHTML = '<span class="material-icons">close</span>';
            closeBtn.addEventListener('click', () => {
                modal.remove();
                overlay.remove();
            });
            modal.querySelector('.account-header').appendChild(closeBtn);
            
            // Add event listeners
            if (currentUser) {
                // Signed in state
                document.getElementById('signout-btn').addEventListener('click', () => {
                    signOut();
                    modal.remove();
                    overlay.remove();
                });
            } else {
                // Signed out state
                document.getElementById('google-signin-btn').addEventListener('click', async () => {
                    const btn = document.getElementById('google-signin-btn');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<div class="spinner"></div>';
                    btn.disabled = true;
                    
                    const user = await signInWithGoogle();
                    if (user) {
                        modal.remove();
                        overlay.remove();
                        // Show updated account modal
                        setTimeout(() => showAccountModal(), 500);
                    } else {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                });
                
                document.getElementById('guest-btn').addEventListener('click', () => {
                    showNotification('Continuing as guest. Settings will be saved locally.');
                    modal.remove();
                    overlay.remove();
                });
            }
            
            // Close on overlay click
            overlay.addEventListener('click', () => {
                modal.remove();
                overlay.remove();
            });
        }

        // Initialize
        async function init() {
            // Initialize Firebase auth state listener
            auth.onAuthStateChanged((user) => {
                currentUser = user;
                updateUserDisplay(user);
                
                // Save user info to localStorage if signed in
                if (user) {
                    try {
                        localStorage.setItem('chromeOS-user', JSON.stringify({
                            uid: user.uid,
                            displayName: user.displayName,
                            email: user.email,
                            photoURL: user.photoURL
                        }));
                    } catch (e) {
                        console.error('Error saving user data:', e);
                    }
                } else {
                    localStorage.removeItem('chromeOS-user');
                }
            });

            // Load settings
            loadSettings();
            
            // Load saved user info
            const savedUser = localStorage.getItem('chromeOS-user');
            if (savedUser) {
                try {
                    const userData = JSON.parse(savedUser);
                    updateUserDisplay(userData);
                } catch (e) {
                    console.error('Error loading user data:', e);
                }
            }
            
            createDesktopIcons();
            updateClock();
            setInterval(updateClock, 60000);
            
            document.getElementById('app-launcher').addEventListener('click', showAppLauncher);
            document.getElementById('settings-btn').addEventListener('click', showSettings);
            document.getElementById('account-btn').addEventListener('click', showAccountModal);
            
            // Initialize other system tray buttons
            document.getElementById('notifications-btn').addEventListener('click', () => {
                showNotification('No new notifications');
            });
            
            // Click on desktop to focus it (lower window z-index)
            document.getElementById('desktop').addEventListener('click', (e) => {
                if (e.target === document.getElementById('desktop') || 
                    e.target.classList.contains('desktop-icons-grid')) {
                    // Lower all window z-indices
                    windows.forEach(window => {
                        window.style.zIndex = 100;
                    });
                    windowZIndex = 200; // Reset counter
                    activeWindow = null;
                    
                    // Remove active state from taskbar items
                    taskbarItems.forEach(item => {
                        item.item.classList.remove('active');
                    });
                }
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    openApp(apps[0]); // Open Chrome
                }
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    showSettings();
                }
                if (e.ctrlKey && e.key === 'l') {
                    e.preventDefault();
                    showAccountModal();
                }
                if (e.key === 'Escape') {
                    // Close active modal if any
                    const modal = document.querySelector('.settings-modal, .account-modal, .app-launcher-modal');
                    const overlay = document.querySelector('.modal-overlay');
                    if (modal) {
                        modal.remove();
                        if (overlay) overlay.remove();
                    }
                }
            });
            
            // Handle window resize
            window.addEventListener('resize', () => {
                // Update window boundaries
                windows.forEach(window => {
                    if (window.classList.contains('maximized')) {
                        window.style.width = `calc(100vw - 40px)`;
                        window.style.height = `calc(100vh - 96px)`;
                        window.style.left = '20px';
                        window.style.top = '20px';
                    }
                });
            });
        }

        // Create desktop icons
        function createDesktopIcons() {
            const container = document.getElementById('desktop-icons');
            container.innerHTML = '';
            
            apps.forEach((app) => {
                if (!app.desktop) return;
                
                const icon = document.createElement('div');
                icon.className = 'desktop-icon';
                icon.dataset.appId = app.id;
                icon.title = app.name;
                
                icon.innerHTML = `
                    <span class="material-icons">${app.icon}</span>
                    <span>${app.name}</span>
                `;
                
                // Single click to open app
                icon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openApp(app);
                });
                
                container.appendChild(icon);
                desktopIcons.set(app.id, icon);
            });
        }

        // Open app window
        function openApp(app) {
            let window = windows.get(app.id);
            
            if (window) {
                // Bring to front if window exists
                bringToFront(window);
                if (window.classList.contains('minimized')) {
                    window.classList.remove('minimized');
                }
            } else {
                // Create new window
                window = createWindow(app);
                windows.set(app.id, window);
                document.getElementById('desktop').appendChild(window);
                
                // Create taskbar item
                createTaskbarItem(app, window);
            }
            
            // Update active window
            setActiveWindow(window);
            
            return window;
        }

        // Create window
        function createWindow(app) {
            const windowId = `window_${app.id}_${Date.now()}`;
            const window = document.createElement('div');
            window.className = 'window';
            window.id = windowId;
            window.dataset.appId = app.id;
            
            // Position window with boundaries
            const offset = windows.size * 30;
            const desktop = document.getElementById('desktop');
            const desktopRect = desktop.getBoundingClientRect();
            
            let left = 50 + offset;
            let top = 50 + offset;
            
            // Ensure window stays within desktop bounds
            left = Math.min(left, desktopRect.width - 400);
            top = Math.min(top, desktopRect.height - 300);
            
            window.style.left = `${Math.max(0, left)}px`;
            window.style.top = `${Math.max(0, top)}px`;
            window.style.width = '800px';
            window.style.height = '600px';
            window.style.zIndex = windowZIndex++;
            
            window.innerHTML = `
                <div class="title-bar">
                    <span class="material-icons window-icon">${app.icon}</span>
                    <span class="title-text">${app.name}</span>
                    <div class="window-controls">
                        <button class="win-btn minimize" title="Minimize">
                            <span class="material-icons">minimize</span>
                        </button>
                        <button class="win-btn maximize" title="Maximize">
                            <span class="material-icons">crop_square</span>
                        </button>
                        <button class="win-btn close" title="Close">
                            <span class="material-icons">close</span>
                        </button>
                    </div>
                </div>
                <div class="window-content">
                    <iframe src="${app.url}" title="${app.name}" 
                            sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-modals"
                            allowfullscreen></iframe>
                </div>
                <div class="window-resize-handle"></div>
            `;
            
            // Add event listeners for window controls
            const titleBar = window.querySelector('.title-bar');
            const minimizeBtn = window.querySelector('.minimize');
            const maximizeBtn = window.querySelector('.maximize');
            const closeBtn = window.querySelector('.close');
            const resizeHandle = window.querySelector('.window-resize-handle');
            
            // Make draggable
            makeDraggable(window, titleBar);
            
            // Make resizable
            makeResizable(window, resizeHandle);
            
            // Window controls
            minimizeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                minimizeWindow(window);
            });
            
            maximizeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleMaximize(window);
            });
            
            closeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                closeWindow(window);
            });
            
            // Click to focus
            window.addEventListener('mousedown', (e) => {
                if (!e.target.closest('.win-btn')) {
                    bringToFront(window);
                }
            });
            
            // Touch support
            window.addEventListener('touchstart', (e) => {
                if (!e.target.closest('.win-btn')) {
                    bringToFront(window);
                }
            });
            
            return window;
        }

        // Make window draggable
        function makeDraggable(window, handle) {
            let isDragging = false;
            let startX, startY, startLeft, startTop;
            
            const startDrag = (e) => {
                if (e.target.closest('.win-btn')) return;
                
                isDragging = true;
                bringToFront(window);
                
                const rect = window.getBoundingClientRect();
                startX = e.clientX || e.touches[0].clientX;
                startY = e.clientY || e.touches[0].clientY;
                startLeft = rect.left;
                startTop = rect.top;
                
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', stopDrag);
                document.addEventListener('touchmove', drag, { passive: false });
                document.addEventListener('touchend', stopDrag);
            };
            
            const drag = (e) => {
                if (!isDragging) return;
                
                e.preventDefault();
                
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                
                let newX = startLeft + (clientX - startX);
                let newY = startTop + (clientY - startY);
                
                // Boundary checking
                const desktop = document.getElementById('desktop');
                const maxX = desktop.clientWidth - window.clientWidth;
                const maxY = desktop.clientHeight - window.clientHeight;
                
                newX = Math.max(0, Math.min(newX, maxX));
                newY = Math.max(0, Math.min(newY, maxY));
                
                window.style.left = `${newX}px`;
                window.style.top = `${newY}px`;
            };
            
            const stopDrag = () => {
                isDragging = false;
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('mouseup', stopDrag);
                document.removeEventListener('touchmove', drag);
                document.removeEventListener('touchend', stopDrag);
            };
            
            handle.addEventListener('mousedown', startDrag);
            handle.addEventListener('touchstart', startDrag, { passive: true });
        }

        // Make window resizable
        function makeResizable(window, handle) {
            let isResizing = false;
            let startX, startY, startWidth, startHeight;
            
            const startResize = (e) => {
                e.preventDefault();
                isResizing = true;
                bringToFront(window);
                
                const rect = window.getBoundingClientRect();
                startX = e.clientX || e.touches[0].clientX;
                startY = e.clientY || e.touches[0].clientY;
                startWidth = rect.width;
                startHeight = rect.height;
                
                document.addEventListener('mousemove', resize);
                document.addEventListener('mouseup', stopResize);
                document.addEventListener('touchmove', resize, { passive: false });
                document.addEventListener('touchend', stopResize);
            };
            
            const resize = (e) => {
                if (!isResizing) return;
                
                e.preventDefault();
                
                const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                
                const newWidth = Math.max(400, startWidth + (clientX - startX));
                const newHeight = Math.max(300, startHeight + (clientY - startY));
                
                // Max boundaries
                const desktop = document.getElementById('desktop');
                const maxWidth = desktop.clientWidth - window.offsetLeft;
                const maxHeight = desktop.clientHeight - window.offsetTop;
                
                window.style.width = `${Math.min(newWidth, maxWidth)}px`;
                window.style.height = `${Math.min(newHeight, maxHeight)}px`;
            };
            
            const stopResize = () => {
                isResizing = false;
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
                document.removeEventListener('touchmove', resize);
                document.removeEventListener('touchend', stopResize);
            };
            
            handle.addEventListener('mousedown', startResize);
            handle.addEventListener('touchstart', startResize, { passive: true });
            
            // Also allow resizing from bottom-right corner
            window.addEventListener('mousedown', (e) => {
                if (e.offsetX > window.offsetWidth - 15 && 
                    e.offsetY > window.offsetHeight - 15) {
                    startResize(e);
                }
            });
        }

        // Create taskbar item
        function createTaskbarItem(app, window) {
            const taskbar = document.getElementById('taskbar');
            const item = document.createElement('div');
            item.className = 'taskbar-item';
            item.dataset.appId = app.id;
            item.title = app.name;
            
            item.innerHTML = `<span class="material-icons">${app.icon}</span>`;
            
            item.addEventListener('click', () => {
                if (window.classList.contains('minimized')) {
                    // Restore window
                    window.classList.remove('minimized');
                    bringToFront(window);
                } else {
                    // Minimize window
                    minimizeWindow(window);
                }
            });
            
            taskbar.appendChild(item);
            taskbarItems.set(app.id, { item, window });
        }

        // Window management functions
        function minimizeWindow(window) {
            window.classList.add('minimized');
            updateTaskbarItem(window.dataset.appId, false);
        }

        function toggleMaximize(window) {
            window.classList.toggle('maximized');
            const icon = window.querySelector('.maximize .material-icons');
            icon.textContent = window.classList.contains('maximized') ? 'filter_none' : 'crop_square';
        }

        function closeWindow(window) {
            const appId = window.dataset.appId;
            
            // Remove window
            window.remove();
            windows.delete(appId);
            
            // Remove taskbar item
            const taskbarItem = taskbarItems.get(appId);
            if (taskbarItem) {
                taskbarItem.item.remove();
                taskbarItems.delete(appId);
            }
        }

        function bringToFront(window) {
            window.style.zIndex = windowZIndex++;
            setActiveWindow(window);
        }

        function setActiveWindow(window) {
            if (activeWindow) {
                activeWindow.classList.remove('active');
            }
            
            window.classList.add('active');
            activeWindow = window;
            
            // Update taskbar
            updateTaskbarItem(window.dataset.appId, true);
        }

        function updateTaskbarItem(appId, isActive) {
            const taskbarItem = taskbarItems.get(appId);
            if (taskbarItem) {
                if (isActive) {
                    taskbarItem.item.classList.add('active');
                } else {
                    taskbarItem.item.classList.remove('active');
                }
            }
        }

        // Show app launcher
        function showAppLauncher() {
            // Create launcher modal
            const overlay = createModalOverlay();
            const launcher = document.createElement('div');
            launcher.className = 'app-launcher-modal';
            
            launcher.innerHTML = `
                <div style="width: 600px; max-width: 90%; max-height: 90vh; overflow-y: auto;">
                    <div style="margin-bottom: 40px; text-align: center;">
                        <h2 style="color: var(--on-surface); margin-bottom: 20px;">Applications</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, 100px); gap: 20px; justify-content: center;">
                            ${apps.map(app => `
                                <div class="desktop-icon" style="color: var(--on-surface); cursor: pointer; padding: 15px;" data-app-id="${app.id}" title="${app.name}">
                                    <span class="material-icons" style="font-size: 36px;">${app.icon}</span>
                                    <span style="margin-top: 5px; font-size: 12px;">${app.name}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div style="text-align: center; padding: 20px 0;">
                        <button id="close-launcher" style="padding: 10px 30px; background: var(--primary); color: white; border: none; border-radius: 24px; cursor: pointer; font-size: 14px;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(launcher);
            
            // Add click handlers for apps
            launcher.querySelectorAll('.desktop-icon').forEach(icon => {
                icon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const appId = e.currentTarget.dataset.appId;
                    const app = apps.find(a => a.id === appId);
                    if (app) {
                        openApp(app);
                        launcher.remove();
                        overlay.remove();
                    }
                });
            });
            
            // Close button
            launcher.querySelector('#close-launcher').addEventListener('click', (e) => {
                e.stopPropagation();
                launcher.remove();
                overlay.remove();
            });
            
            // Close on background click
            overlay.addEventListener('click', () => {
                launcher.remove();
                overlay.remove();
            });
            
            // Close on escape
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    launcher.remove();
                    overlay.remove();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        // Show settings
        function showSettings() {
            // Create settings modal
            const overlay = createModalOverlay();
            const modal = document.createElement('div');
            modal.className = 'settings-modal';
            modal.innerHTML = `
                <div class="modal-header">
                    <div class="modal-title">Settings</div>
                    <button class="win-btn close" id="close-settings">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                <div class="modal-content">
                    <div class="setting-item">
                        <label class="setting-label">Theme</label>
                        <div class="setting-control">
                            <select id="theme-select">
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <label class="setting-label">Wallpaper</label>
                        <div class="setting-control">
                            <select id="wallpaper-select">
                                <option value="">Select a wallpaper</option>
                                ${wallpapers.map((wp, i) => `
                                    <option value="${wp}">Wallpaper ${i + 1}</option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <label class="setting-label">Custom Wallpaper URL</label>
                        <div class="setting-control">
                            <input type="text" id="custom-wallpaper-url" placeholder="Enter image URL" value="${settings.customBackgroundUrl}">
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <label class="setting-label">Apply Custom URL</label>
                        <div class="setting-control">
                            <div class="checkbox-container">
                                <div class="checkbox ${settings.customBackgroundUrl ? 'checked' : ''}" id="use-custom-url"></div>
                                <span>Use custom wallpaper URL</span>
                            </div>
                        </div>
                    </div>
                    
                    ${currentUser ? `
                    <div class="setting-item">
                        <label class="setting-label">Account</label>
                        <div class="setting-control">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="user-avatar">
                                    ${currentUser.photoURL ? 
                                        `<img src="${currentUser.photoURL}" alt="${currentUser.displayName}" onerror="this.onerror=null; this.parentElement.innerHTML='<span>${(currentUser.displayName || 'User').split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)}</span>'; this.parentElement.style.backgroundColor=getRandomColor();">` : 
                                        `<span>${(currentUser.displayName || 'User').split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2)}</span>`
                                    }
                                </div>
                                <div style="min-width: 0;">
                                    <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${currentUser.displayName || 'User'}</div>
                                    <div style="font-size: 12px; color: #5f6368; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${currentUser.email}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancel-settings">Cancel</button>
                    <button class="btn btn-primary" id="save-settings">Save</button>
                </div>
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            
            // Set current values
            document.getElementById('theme-select').value = settings.theme;
            if (settings.customBackgroundUrl) {
                document.getElementById('use-custom-url').classList.add('checked');
            }
            
            // Add event listeners
            document.getElementById('close-settings').addEventListener('click', () => {
                modal.remove();
                overlay.remove();
            });
            
            document.getElementById('cancel-settings').addEventListener('click', () => {
                modal.remove();
                overlay.remove();
            });
            
            document.getElementById('save-settings').addEventListener('click', () => {
                // Get values
                settings.theme = document.getElementById('theme-select').value;
                settings.backgroundUrl = document.getElementById('wallpaper-select').value || wallpapers[0];
                settings.customBackgroundUrl = document.getElementById('custom-wallpaper-url').value;
                
                if (!document.getElementById('use-custom-url').classList.contains('checked')) {
                    settings.customBackgroundUrl = '';
                }
                
                // Apply and save
                applySettings();
                saveSettings();
                modal.remove();
                overlay.remove();
                showNotification('Settings saved successfully');
            });
            
            // Toggle custom URL checkbox
            document.getElementById('use-custom-url').addEventListener('click', function() {
                this.classList.toggle('checked');
            });
            
            // Close on overlay click
            overlay.addEventListener('click', () => {
                modal.remove();
                overlay.remove();
            });
            
            // Close on escape
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    overlay.remove();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        // Update clock
        function updateClock() {
            try {
                const now = new Date();
                const timeString = now.toLocaleTimeString([], { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                document.getElementById('clock').textContent = timeString;
            } catch (e) {
                console.error('Error updating clock:', e);
            }
        }

        // Initialize on load
        window.addEventListener('load', init);
        
        // Prevent context menu
        document.addEventListener('contextmenu', (e) => {
            if (e.target.closest('.window') || e.target.closest('#desktop')) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
